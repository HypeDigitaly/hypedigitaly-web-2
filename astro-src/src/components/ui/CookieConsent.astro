---
import { translations, type Language, getLocalizedHref } from '../../scripts/translations';

interface Props {
  lang?: Language;
}

const { lang = 'cs' } = Astro.props;
const t = translations[lang];

// Helper for localized links
const href = (path: string) => getLocalizedHref(path, lang);
---

<!-- Cookie Consent Banner - Bottom LEFT Popup -->
<div id="cookie-consent-banner" class="cookie-banner hidden">
  <div class="cookie-banner-inner">
    <!-- Header -->
    <div class="cookie-header">
      <h3 class="cookie-title">{t.cookie_title || 'Nastavení cookies'}</h3>
      <p class="cookie-subtitle">{t.cookie_subtitle || 'Respektujeme vaše soukromí'}</p>
    </div>

    <!-- Description -->
    <p class="cookie-description">
      {t.cookie_description || 'Používáme cookies k zajištění správného fungování webu a ke zlepšení vašeho zážitku.'}
    </p>

    <!-- Cookie Categories (Collapsed by default) -->
    <div id="cookie-details" class="cookie-details hidden">
      <!-- Necessary Cookies -->
      <div class="cookie-category">
        <div class="cookie-category-header">
          <div class="cookie-category-info">
            <div class="cookie-category-icon necessary">
              <iconify-icon icon="solar:shield-check-bold" class="text-lg"></iconify-icon>
            </div>
            <div>
              <h4 class="cookie-category-title">{t.cookie_necessary_title || 'Nezbytné'}</h4>
              <span class="cookie-category-badge necessary">{t.cookie_always_active || 'Vždy aktivní'}</span>
            </div>
          </div>
          <label class="cookie-toggle disabled">
            <input type="checkbox" id="cookie-necessary" checked disabled>
            <span class="cookie-toggle-slider"></span>
          </label>
        </div>
        <p class="cookie-category-desc">
          {t.cookie_necessary_desc || 'Tyto cookies jsou nezbytné pro správné fungování webu. Bez nich by web nefungoval správně. Zahrnují cookies pro správu relace, jazykové preference a základní bezpečnostní funkce.'}
        </p>
      </div>

      <!-- Functional Cookies -->
      <div class="cookie-category">
        <div class="cookie-category-header">
          <div class="cookie-category-info">
            <div class="cookie-category-icon functional">
              <iconify-icon icon="solar:settings-bold" class="text-lg"></iconify-icon>
            </div>
            <div>
              <h4 class="cookie-category-title">{t.cookie_functional_title || 'Funkční'}</h4>
              <span class="cookie-category-badge">{t.cookie_optional || 'Volitelné'}</span>
            </div>
          </div>
          <label class="cookie-toggle">
            <input type="checkbox" id="cookie-functional">
            <span class="cookie-toggle-slider"></span>
          </label>
        </div>
        <p class="cookie-category-desc">
          {t.cookie_functional_desc || 'Funkční cookies umožňují rozšířené funkce webu, jako je personalizace obsahu, ukládání vašich preferencí a zapamatování vašich voleb na webu.'}
        </p>
      </div>

      <!-- Analytics Cookies -->
      <div class="cookie-category">
        <div class="cookie-category-header">
          <div class="cookie-category-info">
            <div class="cookie-category-icon analytics">
              <iconify-icon icon="solar:chart-2-bold" class="text-lg"></iconify-icon>
            </div>
            <div>
              <h4 class="cookie-category-title">{t.cookie_analytics_title || 'Analytické'}</h4>
              <span class="cookie-category-badge">{t.cookie_optional || 'Volitelné'}</span>
            </div>
          </div>
          <label class="cookie-toggle">
            <input type="checkbox" id="cookie-analytics">
            <span class="cookie-toggle-slider"></span>
          </label>
        </div>
        <p class="cookie-category-desc">
          {t.cookie_analytics_desc || 'Analytické cookies nám pomáhají pochopit, jak návštěvníci používají web. Shromažďují anonymizované informace o počtu návštěvníků, zdrojích návštěvnosti a chování na webu.'}
        </p>
      </div>

      <!-- Marketing Cookies -->
      <div class="cookie-category">
        <div class="cookie-category-header">
          <div class="cookie-category-info">
            <div class="cookie-category-icon marketing">
              <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
                <path d="M18 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6ZM6.5 9a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5ZM7 11a4 4 0 0 0-4 4v5h8v-5a4 4 0 0 0-4-4Zm11-1a3 3 0 0 0-3 3v7h6v-7a3 3 0 0 0-3-3Z"/>
              </svg>
            </div>
            <div>
              <h4 class="cookie-category-title">{t.cookie_marketing_title || 'Marketingové'}</h4>
              <span class="cookie-category-badge">{t.cookie_optional || 'Volitelné'}</span>
            </div>
          </div>
          <label class="cookie-toggle">
            <input type="checkbox" id="cookie-marketing">
            <span class="cookie-toggle-slider"></span>
          </label>
        </div>
        <p class="cookie-category-desc">
          {t.cookie_marketing_desc || 'Marketingové cookies sledují vaši aktivitu na webu a pomáhají zobrazovat relevantní reklamy. Mohou být využity třetími stranami k vytvoření profilu vašich zájmů.'}
        </p>
      </div>
    </div>

    <!-- Buttons - Simplified Layout -->
    <div class="cookie-buttons">
      <div class="cookie-btn-row">
        <button id="cookie-show-details" class="cookie-btn-details" data-show-text={t.cookie_customize || 'Přizpůsobit'} data-hide-text={t.cookie_hide_details || 'Skrýt detaily'}>
          <iconify-icon icon="solar:settings-minimalistic-bold" class="text-base"></iconify-icon>
          <span>{t.cookie_customize || 'Přizpůsobit'}</span>
        </button>
        <button id="cookie-reject-all" class="cookie-btn-reject">
          {t.cookie_reject_all || 'Odmítnout vše'}
        </button>
        <button id="cookie-accept-all" class="cookie-btn-accept">
          {t.cookie_accept_all || 'Přijmout vše'}
        </button>
      </div>
      <button id="cookie-accept-selected" class="cookie-btn-selected hidden">
        {t.cookie_accept_selected || 'Uložit výběr'}
      </button>
    </div>

    <!-- Link -->
    <div class="cookie-links">
      <a href={href("/privacy-policy")} class="cookie-link">
        {t.cookie_privacy_policy || 'Zásady ochrany osobních údajů'}
      </a>
    </div>
  </div>
</div>

<!-- Cookie Settings Button (Always visible after consent) - LEFT BOTTOM -->
<button id="cookie-settings-btn" class="cookie-settings-btn hidden" aria-label="{t.cookie_settings || 'Nastavení cookies'}">
  <svg class="cookie-icon-svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
    <path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10c0-.34-.017-.676-.05-1.008a1 1 0 0 0-1.143-.883 2.5 2.5 0 0 1-2.957-2.957 1 1 0 0 0-.883-1.143A10.02 10.02 0 0 0 12 2Zm-1.5 5a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3Zm-3 6a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3Zm6.5 1a1 1 0 1 1 0 2 1 1 0 0 1 0-2Zm-2-4a1 1 0 1 1 0 2 1 1 0 0 1 0-2Z"/>
  </svg>
</button>

<script>
  // ==================== COOKIE CONSENT MANAGER ====================
  class CookieConsentManager {
    private banner: HTMLElement | null;
    private settingsBtn: HTMLElement | null;
    private detailsSection: HTMLElement | null;
    private showDetailsBtn: HTMLElement | null;
    private acceptAllBtn: HTMLElement | null;
    private acceptSelectedBtn: HTMLElement | null;
    private rejectAllBtn: HTMLElement | null;
    private functionalCheckbox: HTMLInputElement | null;
    private analyticsCheckbox: HTMLInputElement | null;
    private marketingCheckbox: HTMLInputElement | null;
    private detailsVisible: boolean = false;

    constructor() {
      this.banner = document.getElementById('cookie-consent-banner');
      this.settingsBtn = document.getElementById('cookie-settings-btn');
      this.detailsSection = document.getElementById('cookie-details');
      this.showDetailsBtn = document.getElementById('cookie-show-details');
      this.acceptAllBtn = document.getElementById('cookie-accept-all');
      this.acceptSelectedBtn = document.getElementById('cookie-accept-selected');
      this.rejectAllBtn = document.getElementById('cookie-reject-all');
      this.functionalCheckbox = document.getElementById('cookie-functional') as HTMLInputElement;
      this.analyticsCheckbox = document.getElementById('cookie-analytics') as HTMLInputElement;
      this.marketingCheckbox = document.getElementById('cookie-marketing') as HTMLInputElement;

      this.init();
    }

    private init() {
      // Check if consent was already given
      const consent = this.getConsent();
      
      if (!consent) {
        // Show banner if no consent
        this.showBanner();
      } else {
        // Show settings button and apply consent
        this.showSettingsButton();
        this.applyConsent(consent);
      }

      this.bindEvents();
    }

    private bindEvents() {
      // Show details button
      this.showDetailsBtn?.addEventListener('click', () => this.toggleDetails());

      // Accept all button
      this.acceptAllBtn?.addEventListener('click', () => {
        this.saveConsent({
          necessary: true,
          functional: true,
          analytics: true,
          marketing: true,
          timestamp: new Date().toISOString()
        });
        this.hideBanner();
        this.showSettingsButton();
      });

      // Accept selected button
      this.acceptSelectedBtn?.addEventListener('click', () => {
        this.saveConsent({
          necessary: true,
          functional: this.functionalCheckbox?.checked || false,
          analytics: this.analyticsCheckbox?.checked || false,
          marketing: this.marketingCheckbox?.checked || false,
          timestamp: new Date().toISOString()
        });
        this.hideBanner();
        this.showSettingsButton();
      });

      // Reject all button
      this.rejectAllBtn?.addEventListener('click', () => {
        this.saveConsent({
          necessary: true,
          functional: false,
          analytics: false,
          marketing: false,
          timestamp: new Date().toISOString()
        });
        this.hideBanner();
        this.showSettingsButton();
      });

      // Settings button (re-open banner)
      this.settingsBtn?.addEventListener('click', () => {
        const consent = this.getConsent();
        if (consent) {
          // Restore checkboxes to saved state
          if (this.functionalCheckbox) this.functionalCheckbox.checked = consent.functional;
          if (this.analyticsCheckbox) this.analyticsCheckbox.checked = consent.analytics;
          if (this.marketingCheckbox) this.marketingCheckbox.checked = consent.marketing;
        }
        // Reset details state before showing banner
        this.resetDetailsState();
        this.showBanner();
        this.hideSettingsButton();
      });

      // Listen for checkbox changes to show "Accept selected" button
      [this.functionalCheckbox, this.analyticsCheckbox, this.marketingCheckbox].forEach(checkbox => {
        checkbox?.addEventListener('change', () => {
          if (this.detailsVisible) {
            this.acceptSelectedBtn?.classList.remove('hidden');
          }
        });
      });
    }

    private toggleDetails() {
      this.detailsVisible = !this.detailsVisible;
      
      if (this.detailsVisible) {
        this.detailsSection?.classList.remove('hidden');
        this.detailsSection?.classList.add('cookie-details-visible');
        this.showDetailsBtn?.classList.add('active');
        this.acceptSelectedBtn?.classList.remove('hidden');
        this.banner?.classList.add('expanded');
        
        // Change button text
        const btnText = this.showDetailsBtn?.querySelector('span');
        if (btnText) {
          btnText.textContent = this.showDetailsBtn?.getAttribute('data-hide-text') || 'Skrýt detaily';
        }
      } else {
        this.detailsSection?.classList.add('hidden');
        this.detailsSection?.classList.remove('cookie-details-visible');
        this.showDetailsBtn?.classList.remove('active');
        this.acceptSelectedBtn?.classList.add('hidden');
        this.banner?.classList.remove('expanded');
        
        // Change button text back
        const btnText = this.showDetailsBtn?.querySelector('span');
        if (btnText) {
          btnText.textContent = this.showDetailsBtn?.getAttribute('data-show-text') || 'Přizpůsobit';
        }
      }
    }

    private showBanner() {
      this.banner?.classList.remove('hidden');
      this.banner?.classList.add('cookie-banner-visible');
      // Don't block scrolling - it's just a popup now
    }

    private hideBanner() {
      this.banner?.classList.add('hidden');
      this.banner?.classList.remove('cookie-banner-visible');
      
      // Reset details section and button text
      this.resetDetailsState();
    }
    
    private resetDetailsState() {
      this.detailsVisible = false;
      this.detailsSection?.classList.add('hidden');
      this.detailsSection?.classList.remove('cookie-details-visible');
      this.showDetailsBtn?.classList.remove('active');
      this.acceptSelectedBtn?.classList.add('hidden');
      this.banner?.classList.remove('expanded');
      
      // Reset button text to "Přizpůsobit"
      const btnText = this.showDetailsBtn?.querySelector('span');
      if (btnText) {
        btnText.textContent = this.showDetailsBtn?.getAttribute('data-show-text') || 'Přizpůsobit';
      }
    }

    private showSettingsButton() {
      this.settingsBtn?.classList.remove('hidden');
      this.settingsBtn?.classList.add('cookie-settings-visible');
    }

    private hideSettingsButton() {
      this.settingsBtn?.classList.add('hidden');
      this.settingsBtn?.classList.remove('cookie-settings-visible');
    }

    private saveConsent(consent: CookieConsent) {
      localStorage.setItem('cookie_consent', JSON.stringify(consent));
      this.applyConsent(consent);
      
      // Dispatch custom event for other scripts to listen
      window.dispatchEvent(new CustomEvent('cookieConsentUpdated', { detail: consent }));
    }

    private getConsent(): CookieConsent | null {
      const stored = localStorage.getItem('cookie_consent');
      if (stored) {
        try {
          return JSON.parse(stored);
        } catch {
          return null;
        }
      }
      return null;
    }

    private applyConsent(consent: CookieConsent) {
      // Enable/disable scripts based on consent
      if (consent.analytics) {
        this.enableAnalytics();
      } else {
        this.disableAnalytics();
      }

      if (consent.marketing) {
        this.enableMarketing();
      } else {
        this.disableMarketing();
      }

      if (consent.functional) {
        this.enableFunctional();
      } else {
        this.disableFunctional();
      }
    }

    private enableAnalytics() {
      // Enable Google Analytics or other analytics scripts
      document.querySelectorAll('script[data-cookiecategory="analytics"]').forEach(script => {
        if (script.getAttribute('type') === 'text/plain') {
          const newScript = document.createElement('script');
          newScript.textContent = script.textContent;
          if (script.getAttribute('src')) {
            newScript.src = script.getAttribute('src') || '';
          }
          newScript.setAttribute('data-cookiecategory', 'analytics');
          script.parentNode?.replaceChild(newScript, script);
        }
      });

      if (typeof window.gtag === 'function') {
        window.gtag('consent', 'update', {
          'analytics_storage': 'granted'
        });
      }
    }

    private disableAnalytics() {
      if (typeof window.gtag === 'function') {
        window.gtag('consent', 'update', {
          'analytics_storage': 'denied'
        });
      }
      this.deleteCookiesByPattern(['_ga', '_gid', '_gat']);
    }

    private enableMarketing() {
      document.querySelectorAll('script[data-cookiecategory="marketing"]').forEach(script => {
        if (script.getAttribute('type') === 'text/plain') {
          const newScript = document.createElement('script');
          newScript.textContent = script.textContent;
          if (script.getAttribute('src')) {
            newScript.src = script.getAttribute('src') || '';
          }
          newScript.setAttribute('data-cookiecategory', 'marketing');
          script.parentNode?.replaceChild(newScript, script);
        }
      });

      if (typeof window.gtag === 'function') {
        window.gtag('consent', 'update', {
          'ad_storage': 'granted',
          'ad_user_data': 'granted',
          'ad_personalization': 'granted'
        });
      }
    }

    private disableMarketing() {
      if (typeof window.gtag === 'function') {
        window.gtag('consent', 'update', {
          'ad_storage': 'denied',
          'ad_user_data': 'denied',
          'ad_personalization': 'denied'
        });
      }
      this.deleteCookiesByPattern(['_fbp', '_fbc', 'fr']);
    }

    private enableFunctional() {
      document.querySelectorAll('script[data-cookiecategory="functional"]').forEach(script => {
        if (script.getAttribute('type') === 'text/plain') {
          const newScript = document.createElement('script');
          newScript.textContent = script.textContent;
          if (script.getAttribute('src')) {
            newScript.src = script.getAttribute('src') || '';
          }
          newScript.setAttribute('data-cookiecategory', 'functional');
          script.parentNode?.replaceChild(newScript, script);
        }
      });

      if (typeof window.gtag === 'function') {
        window.gtag('consent', 'update', {
          'functionality_storage': 'granted',
          'personalization_storage': 'granted'
        });
      }
    }

    private disableFunctional() {
      if (typeof window.gtag === 'function') {
        window.gtag('consent', 'update', {
          'functionality_storage': 'denied',
          'personalization_storage': 'denied'
        });
      }
    }

    private deleteCookiesByPattern(patterns: string[]) {
      const cookies = document.cookie.split(';');
      for (const cookie of cookies) {
        const cookieName = cookie.split('=')[0].trim();
        for (const pattern of patterns) {
          if (cookieName.startsWith(pattern)) {
            document.cookie = `${cookieName}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/`;
            document.cookie = `${cookieName}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/; domain=${window.location.hostname}`;
            document.cookie = `${cookieName}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/; domain=.${window.location.hostname}`;
          }
        }
      }
    }
  }

  interface CookieConsent {
    necessary: boolean;
    functional: boolean;
    analytics: boolean;
    marketing: boolean;
    timestamp: string;
  }

  declare global {
    interface Window {
      gtag?: (...args: any[]) => void;
      CookieConsentManager?: CookieConsentManager;
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    window.CookieConsentManager = new CookieConsentManager();
  });

  (window as any).hasCookieConsent = function(category: 'necessary' | 'functional' | 'analytics' | 'marketing'): boolean {
    const stored = localStorage.getItem('cookie_consent');
    if (stored) {
      try {
        const consent = JSON.parse(stored);
        return consent[category] === true;
      } catch {
        return false;
      }
    }
    return false;
  };
</script>
