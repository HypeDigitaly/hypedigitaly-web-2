---
import { translations, type Language } from '../../scripts/translations';

interface Props {
  lang: Language;
  variant?: 'teal' | 'orange';
}

const { lang, variant = 'orange' } = Astro.props;
const t = translations[lang];

// Image data - consistent across the site for RAGus.ai
const slides = [
  { src: "/assets/images/ragus/01.PNG", alt: "RAGus.ai Dashboard" },
  { src: "/assets/images/ragus/02.PNG", alt: "RAGus.ai Features" },
  { src: "/assets/images/ragus/03.PNG", alt: "RAGus.ai Analytics" },
  { src: "/assets/images/ragus/04.PNG", alt: "RAGus.ai Management" }
];

const accentClass = variant === 'teal' ? 'primary' : 'orange-400';
const dotActiveClass = variant === 'teal' ? 'bg-primary' : 'bg-orange-400';
const borderClass = variant === 'teal' ? 'border-primary/20' : 'border-orange-500/20';
---

<div class="ragus-slideshow-container group/slideshow-wrapper">
  <div class={`ragus-slideshow relative aspect-[16/9] overflow-hidden bg-[#0d0d0d] rounded-2xl shadow-2xl cursor-pointer group/slideshow border ${borderClass}`}>
    <!-- Slides -->
    {slides.map((slide, index) => (
      <div class={`ragus-slide ${index === 0 ? 'active' : ''}`}>
        <img src={slide.src} alt={slide.alt} class="w-full h-full object-contain rounded-xl" loading="lazy">
      </div>
    ))}
    
    <!-- Zoom Indicator Overlay -->
    <div class="absolute inset-0 bg-black/20 opacity-0 group-hover/slideshow:opacity-100 transition-opacity flex items-center justify-center pointer-events-none z-0">
      <div class="w-12 h-12 rounded-full bg-white/10 backdrop-blur-md border border-white/20 flex items-center justify-center text-white/70">
        <iconify-icon icon="solar:magnifer-zoom-in-linear" class="text-2xl"></iconify-icon>
      </div>
    </div>

    <!-- Navigation Arrows -->
    <button class="ragus-prev absolute left-3 md:left-4 top-1/2 -translate-y-1/2 w-11 h-11 md:w-12 md:h-12 rounded-full bg-black/80 backdrop-blur-md border-2 border-white/30 flex items-center justify-center text-white shadow-lg hover:bg-black/90 hover:border-white/50 hover:scale-105 active:scale-95 transition-all z-10" aria-label="Previous">
      <iconify-icon icon="solar:arrow-left-linear" class="text-xl md:text-2xl drop-shadow-sm"></iconify-icon>
    </button>
    <button class="ragus-next absolute right-3 md:right-4 top-1/2 -translate-y-1/2 w-11 h-11 md:w-12 md:h-12 rounded-full bg-black/80 backdrop-blur-md border-2 border-white/30 flex items-center justify-center text-white shadow-lg hover:bg-black/90 hover:border-white/50 hover:scale-105 active:scale-95 transition-all z-10" aria-label="Next">
      <iconify-icon icon="solar:arrow-right-linear" class="text-xl md:text-2xl drop-shadow-sm"></iconify-icon>
    </button>
  </div>
  
  <!-- Dots Indicator - Below Image -->
  <div class="flex justify-center gap-2 mt-5">
    {slides.map((_, index) => (
      <button 
        class={`ragus-dot w-2.5 h-2.5 rounded-full transition-all ${index === 0 ? dotActiveClass : 'bg-white/30'}`} 
        data-slide={index}
        aria-label={`Go to slide ${index + 1}`}
      ></button>
    ))}
  </div>

  <!-- Fullscreen Modal -->
  <div class="ragus-fullscreen-modal fixed inset-0 z-[9999] hidden pointer-events-none">
    <div class="ragus-modal-backdrop absolute inset-0 bg-black/70 backdrop-blur-lg pointer-events-none"></div>
    <div class="ragus-modal-content absolute inset-0 flex items-center justify-center p-4 md:p-8 pointer-events-auto">
      <!-- Modal Slides Container -->
      <div class="ragus-modal-slides relative bg-[#0d0d0d] rounded-2xl shadow-2xl border border-white/10 pointer-events-auto">
        <!-- Images will be cloned here via JS -->
        
        <!-- Close Button - Positioned at corner of slides box -->
        <button class="ragus-modal-close pointer-events-auto" aria-label="Zavřít">
          <iconify-icon icon="solar:close-circle-bold" class="text-4xl"></iconify-icon>
        </button>
      </div>

      <!-- Modal Arrows -->
      <button class="ragus-modal-prev absolute left-4 md:left-8 top-1/2 -translate-y-1/2 w-12 h-12 md:w-14 md:h-14 rounded-full bg-black/70 backdrop-blur-md border-2 border-white/40 flex items-center justify-center text-white shadow-xl hover:bg-black/80 hover:border-white/60 hover:scale-110 active:scale-95 transition-all pointer-events-auto" type="button">
        <iconify-icon icon="solar:arrow-left-linear" class="text-2xl md:text-3xl drop-shadow-md"></iconify-icon>
      </button>
      <button class="ragus-modal-next absolute right-4 md:right-8 top-1/2 -translate-y-1/2 w-12 h-12 md:w-14 md:h-14 rounded-full bg-black/70 backdrop-blur-md border-2 border-white/40 flex items-center justify-center text-white shadow-xl hover:bg-black/80 hover:border-white/60 hover:scale-110 active:scale-95 transition-all pointer-events-auto" type="button">
        <iconify-icon icon="solar:arrow-right-linear" class="text-2xl md:text-3xl drop-shadow-md"></iconify-icon>
      </button>

      <!-- Modal Dots -->
      <div class="absolute bottom-8 left-1/2 -translate-x-1/2 flex justify-center gap-3 pointer-events-auto">
        {slides.map((_, index) => (
          <button 
            class={`ragus-modal-dot w-3 h-3 rounded-full transition-all ${index === 0 ? dotActiveClass : 'bg-white/30'}`} 
            data-slide={index} 
            type="button"
          ></button>
        ))}
      </div>
    </div>
  </div>
</div>

<style define:vars={{ dotColor: variant === 'teal' ? '#00A39A' : '#F97316' }}>
  .ragus-slide {
    position: absolute;
    inset: 0;
    opacity: 0;
    transition: opacity 0.5s ease-in-out;
    pointer-events: none;
  }
  .ragus-slide.active {
    opacity: 1;
    pointer-events: auto;
  }
  .ragus-modal-slide {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.5s ease-in-out;
    pointer-events: none;
  }
  .ragus-modal-slide.active {
    opacity: 1;
    pointer-events: auto;
  }
  .ragus-modal-slides {
    width: 90vw;
    height: 80vh;
    max-width: 1200px;
    overflow: visible; /* Allow close button to overflow corner */
  }
  .ragus-modal-slide img {
    max-width: 100%;
    max-height: 100%;
    width: auto;
    height: auto;
    object-fit: contain;
    border-radius: 0.75rem;
    overflow: hidden;
  }
  
  .ragus-modal-close {
    position: absolute;
    top: -0.75rem;
    right: -0.75rem;
    width: 3rem;
    height: 3rem;
    background: rgba(220, 38, 38, 0.9);
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    z-index: 10002;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    pointer-events: auto;
  }

  @media (max-width: 768px) {
    .ragus-modal-close {
      top: -0.5rem;
      right: -0.5rem;
      width: 2.5rem;
      height: 2.5rem;
    }
  }

  .ragus-modal-close:hover {
    background: rgba(239, 68, 68, 1);
    transform: scale(1.15);
    border-color: rgba(255, 255, 255, 0.6);
    box-shadow: 0 6px 20px rgba(239, 68, 68, 0.5);
  }

  .ragus-modal-close:active {
    transform: scale(0.95);
  }

  .ragus-modal-close iconify-icon {
    font-size: 1.5rem;
  }

  /* Navigation Arrow Enhancements */
  .ragus-prev,
  .ragus-next {
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.1);
  }

  .ragus-prev:hover,
  .ragus-next:hover {
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.6), 0 0 0 1px rgba(255, 255, 255, 0.2);
  }

  .ragus-modal-prev,
  .ragus-modal-next {
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.6), 0 0 20px rgba(0, 0, 0, 0.3);
  }

  .ragus-modal-prev:hover,
  .ragus-modal-next:hover {
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7), 0 0 25px rgba(0, 0, 0, 0.4);
  }

  /* Ensure visibility on touch devices */
  @media (max-width: 768px) {
    .ragus-prev,
    .ragus-next {
      opacity: 1 !important;
    }
    
    .ragus-modal-prev,
    .ragus-modal-next {
      width: 3rem;
      height: 3rem;
    }
  }
</style>

<script is:inline>
  (function() {
    function initAllRagusSlideshows() {
      const containers = document.querySelectorAll('.ragus-slideshow-container');
      
      containers.forEach(container => {
        // Prevent double initialization
        if (container.dataset.initialized) return;
        container.dataset.initialized = "true";

        const slideshow = container.querySelector('.ragus-slideshow');
        const modal = container.querySelector('.ragus-fullscreen-modal');
        if (!slideshow || !modal) return;

        // Move modal to body to avoid transform issues (trapping fixed elements)
        // This ensures the modal is always centered in the viewport
        if (modal.parentElement !== document.body) {
          document.body.appendChild(modal);
        }

        const modalSlidesContainer = modal.querySelector('.ragus-modal-slides');
        const modalBackdrop = modal.querySelector('.ragus-modal-backdrop');
        const slides = slideshow.querySelectorAll('.ragus-slide');
        const prevBtn = slideshow.querySelector('.ragus-prev');
        const nextBtn = slideshow.querySelector('.ragus-next');
        const dots = container.querySelectorAll('.ragus-dot');
        const modalDots = modal.querySelectorAll('.ragus-modal-dot');

        let currentSlide = 0;
        let slideInterval;

        // Initialize modal slides by cloning
        // Note: We check for .ragus-modal-slide specifically because the container 
        // now has a close button as a child.
        const existingSlides = modalSlidesContainer ? modalSlidesContainer.querySelectorAll('.ragus-modal-slide') : [];
        if (modalSlidesContainer && existingSlides.length === 0) {
          slides.forEach((slide, i) => {
            const clone = slide.cloneNode(true);
            clone.className = 'ragus-modal-slide' + (i === 0 ? ' active' : '');
            modalSlidesContainer.appendChild(clone);
          });
        }

        const modalSlides = modalSlidesContainer ? modalSlidesContainer.querySelectorAll('.ragus-modal-slide') : [];

        function showSlide(index) {
          if (index >= slides.length) currentSlide = 0;
          else if (index < 0) currentSlide = slides.length - 1;
          else currentSlide = index;
          
          slides.forEach((slide, i) => slide.classList.toggle('active', i === currentSlide));
          modalSlides.forEach((slide, i) => slide.classList.toggle('active', i === currentSlide));
          
          const dotColor = getComputedStyle(container).getPropertyValue('--dotColor').trim();
          
          const updateDots = (dotsList) => {
            dotsList.forEach((dot, i) => {
              if (i === currentSlide) {
                dot.style.backgroundColor = dotColor;
                dot.classList.remove('bg-white/30');
              } else {
                dot.style.backgroundColor = '';
                dot.classList.add('bg-white/30');
              }
            });
          };

          updateDots(dots);
          updateDots(modalDots);
        }

        function nextSlide() { showSlide(currentSlide + 1); }
        function prevSlide() { showSlide(currentSlide - 1); }
        
        function startAutoplay() { if (!slideInterval) slideInterval = setInterval(nextSlide, 5000); }
        function stopAutoplay() { clearInterval(slideInterval); slideInterval = null; }

        function openModal() {
          modal.classList.remove('hidden');
        }

        function closeModal() {
          modal.classList.add('hidden');
        }

        // Close button handler
        const closeBtn = modal.querySelector('.ragus-modal-close');
        if (closeBtn) {
          closeBtn.onclick = (e) => { e.stopPropagation(); closeModal(); };
        }

        // Global click handler for "click outside" 
        // We use pointer-events: auto on modal-content to catch clicks on the backdrop area
        modal.onclick = (e) => {
          const isBackdrop = e.target === modal || e.target.classList.contains('ragus-modal-content');
          if (isBackdrop) {
            closeModal();
          }
        };

        const modalContent = modal.querySelector('.ragus-modal-content');
        if (modalContent) {
          modalContent.onclick = (e) => {
            if (e.target === modalContent) {
              closeModal();
            }
          };
        }

        if (modalBackdrop) {
          modalBackdrop.style.pointerEvents = 'none'; // Ensure backdrop doesn't block scroll
        }

        // Navigation
        if (prevBtn) prevBtn.onclick = (e) => { e.stopPropagation(); stopAutoplay(); prevSlide(); startAutoplay(); };
        if (nextBtn) nextBtn.onclick = (e) => { e.stopPropagation(); stopAutoplay(); nextSlide(); startAutoplay(); };
        
        const modalPrev = modal.querySelector('.ragus-modal-prev');
        const modalNext = modal.querySelector('.ragus-modal-next');
        if (modalPrev) modalPrev.onclick = (e) => { e.stopPropagation(); stopAutoplay(); prevSlide(); startAutoplay(); };
        if (modalNext) modalNext.onclick = (e) => { e.stopPropagation(); stopAutoplay(); nextSlide(); startAutoplay(); };

        dots.forEach((dot, i) => dot.onclick = () => { stopAutoplay(); showSlide(i); startAutoplay(); });
        modalDots.forEach((dot, i) => dot.onclick = () => { stopAutoplay(); showSlide(i); startAutoplay(); });

        slideshow.onclick = (e) => {
          if (e.target.closest('.ragus-prev') || e.target.closest('.ragus-next')) return;
          openModal();
        };

        // Accessibility & Keyboard
        document.addEventListener('keydown', (e) => {
          if (modal.classList.contains('hidden')) return;
          if (e.key === 'Escape') closeModal();
          if (e.key === 'ArrowLeft') { stopAutoplay(); prevSlide(); startAutoplay(); }
          if (e.key === 'ArrowRight') { stopAutoplay(); nextSlide(); startAutoplay(); }
        });

        // Touch support
        let touchStartX = 0;
        const handleTouchStart = (e) => { touchStartX = e.touches[0].clientX; };
        const handleTouchEnd = (e) => {
          const diff = touchStartX - e.changedTouches[0].clientX;
          if (Math.abs(diff) > 50) { stopAutoplay(); diff > 0 ? nextSlide() : prevSlide(); startAutoplay(); }
        };

        slideshow.addEventListener('touchstart', handleTouchStart, { passive: true });
        slideshow.addEventListener('touchend', handleTouchEnd, { passive: true });
        if (modalSlidesContainer) {
          modalSlidesContainer.addEventListener('touchstart', handleTouchStart, { passive: true });
          modalSlidesContainer.addEventListener('touchend', handleTouchEnd, { passive: true });
        }

        slideshow.onmouseenter = stopAutoplay;
        slideshow.onmouseleave = startAutoplay;
        startAutoplay();
      });
    }

    // Init on load and Astro navigation
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initAllRagusSlideshows);
    } else {
      initAllRagusSlideshows();
    }
    document.addEventListener('astro:page-load', initAllRagusSlideshows);
  })();
</script>

