---
interface Props {
  src: string;
  alt: string;
  class?: string;
}

const { src, alt, class: className = '' } = Astro.props;
const uniqueId = `expandable-${Math.random().toString(36).substr(2, 9)}`;
---

<div class={`expandable-image-wrapper group cursor-pointer ${className}`} data-expandable-id={uniqueId}>
  <!-- Thumbnail Preview -->
  <div class="relative overflow-hidden rounded-2xl border border-white/10 bg-black/20">
    <img 
      src={src} 
      alt={alt} 
      class="w-full h-auto object-contain rounded-2xl"
      loading="lazy"
    >
    <!-- Zoom Indicator Overlay -->
    <div class="absolute inset-0 bg-black/30 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center pointer-events-none">
      <div class="w-12 h-12 rounded-full bg-white/10 backdrop-blur-md border border-white/20 flex items-center justify-center text-white/80 scale-90 group-hover:scale-100 transition-transform duration-300">
        <iconify-icon icon="solar:magnifer-zoom-in-linear" class="text-2xl"></iconify-icon>
      </div>
    </div>
  </div>

  <!-- Fullscreen Modal -->
  <div class="expandable-modal fixed inset-0 z-[9999] hidden" data-modal-id={uniqueId}>
    <div class="absolute inset-0 bg-black/90 backdrop-blur-sm modal-backdrop"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4 md:p-8 pointer-events-none">
      <div class="relative max-w-[95vw] max-h-[90vh] pointer-events-auto">
        <!-- Close Button -->
        <button class="expandable-close absolute -top-3 -right-3 w-12 h-12 bg-red-600/90 hover:bg-red-500 border-2 border-white/30 hover:border-white/50 rounded-full flex items-center justify-center text-white shadow-xl hover:scale-110 active:scale-95 transition-all z-[10000]" aria-label="Zavřít">
          <iconify-icon icon="solar:close-circle-bold" class="text-3xl"></iconify-icon>
        </button>
        <!-- Full Image -->
        <img 
          src={src} 
          alt={alt} 
          class="max-w-full max-h-[85vh] object-contain rounded-xl shadow-2xl border border-white/5"
        >
      </div>
    </div>
  </div>
</div>

<script is:inline>
(function() {
  function initExpandableImages() {
    const wrappers = document.querySelectorAll('.expandable-image-wrapper');
    
    wrappers.forEach(wrapper => {
      if (wrapper.dataset.initialized) return;
      wrapper.dataset.initialized = 'true';
      
      const id = wrapper.dataset.expandableId;
      const modal = document.querySelector(`[data-modal-id="${id}"]`);
      
      if (!modal) return;
      
      const closeBtn = modal.querySelector('.expandable-close');
      const backdrop = modal.querySelector('.modal-backdrop');
      
      // Move modal to body to avoid transform issues (trapping fixed elements)
      if (modal.parentElement !== document.body) {
        document.body.appendChild(modal);
      }
      
      // Open modal on wrapper click
      wrapper.addEventListener('click', (e) => {
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
      });
      
      // Close function
      const closeModal = () => {
        modal.classList.add('hidden');
        document.body.style.overflow = '';
      };
      
      // Close button handler
      if (closeBtn) {
        closeBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          closeModal();
        });
      }
      
      // Click outside to close (on backdrop)
      if (backdrop) {
        backdrop.addEventListener('click', (e) => {
          closeModal();
        });
      }
    });
    
    // Global keyboard handler for all expandable modals
    if (!window._expandableKeyboardInitialized) {
      window._expandableKeyboardInitialized = true;
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          const visibleModals = document.querySelectorAll('.expandable-modal:not(.hidden)');
          visibleModals.forEach(modal => {
            modal.classList.add('hidden');
            document.body.style.overflow = '';
          });
        }
      });
    }
  }
  
  // Handle both initial load and Astro page transitions
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initExpandableImages);
  } else {
    initExpandableImages();
  }
  document.addEventListener('astro:page-load', initExpandableImages);
})();
</script>

