---
import PageLayout from '../../layouts/PageLayout.astro';
import BlogCard from '../../components/blog/BlogCard.astro';
import { translations, type Language } from '../../scripts/translations';
import blogData from '../../data/blog-posts.json';
import type { BlogPost } from '../../types/blog';
import { blogCategories } from '../../types/blog';

// Server-side rendered page - detects language from URL param or cookie
export const prerender = false;

const url = Astro.url;
const langParam = url.searchParams.get('lang');

// Redirect ?lang=cs to clean URL (Czech is default - keeps URLs clean)
if (langParam === 'cs') {
  const cleanUrl = new URL(Astro.url);
  cleanUrl.searchParams.delete('lang');
  const redirectPath = cleanUrl.pathname + (cleanUrl.search || '') + (cleanUrl.hash || '');
  return Astro.redirect(redirectPath || '/blog', 301);
}

const cookieLang = Astro.cookies.get('preferredLanguage')?.value;
const lang: Language = (langParam === 'en' || langParam === 'cs') ? langParam : 
                       (cookieLang === 'en' || cookieLang === 'cs') ? cookieLang : 'cs';
const t = translations[lang];

// Set cookie if language was explicitly selected via URL param
if (langParam && (langParam === 'en' || langParam === 'cs')) {
  Astro.cookies.set('preferredLanguage', langParam, { 
    path: '/', 
    maxAge: 60 * 60 * 24 * 365, // 1 year
    sameSite: 'lax'
  });
}

// Get all posts - filtering will be done client-side
// Posts are displayed in equal-sized cards from left to right
const allPosts = blogData.posts as BlogPost[];

// SEO: Constants
const SITE_URL = 'https://hypedigitaly.ai';

// SEO: CollectionPage Structured Data for Blog Listing
const collectionPageSchema = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "name": t.blog_title,
  "description": t.blog_desc,
  "url": `${SITE_URL}/blog`,
  "mainEntity": {
    "@type": "ItemList",
    "itemListElement": allPosts.map((post, index) => ({
      "@type": "ListItem",
      "position": index + 1,
      "url": `${SITE_URL}/blog/${post.slug}`,
      "name": lang === 'cs' ? post.title_cs : post.title_en
    }))
  },
  "publisher": {
    "@type": "Organization",
    "name": "HypeDigitaly",
    "url": SITE_URL
  }
};

// SEO: BreadcrumbList
const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": lang === 'cs' ? "Domů" : "Home",
      "item": SITE_URL
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Blog",
      "item": `${SITE_URL}/blog`
    }
  ]
};
---

<PageLayout 
  title={t.blog_title}
  description={t.blog_desc}
  lang={lang}
>
  <!-- CollectionPage Structured Data -->
  <script slot="head" type="application/ld+json" set:html={JSON.stringify(collectionPageSchema)} />
  
  <!-- Breadcrumb Structured Data -->
  <script slot="head" type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />
  <!-- ==================== HERO SECTION ==================== -->
  <section class="relative max-w-7xl mx-auto px-4 sm:px-6 pt-12 pb-16">
    <div class="text-center max-w-4xl mx-auto">
      <!-- Badge -->
      <div class="animate-on-scroll [animation:animationIn_0.8s_ease-out_0.1s_both] inline-flex items-center gap-2 px-4 py-2 rounded-full bg-primary/10 border border-primary/20 mb-8">
        <iconify-icon icon="solar:document-text-bold" class="text-primary text-lg"></iconify-icon>
        <span class="text-sm font-medium text-primary">{t.blog_all_posts}</span>
      </div>
      
      <!-- Headline -->
      <h1 class="animate-on-scroll [animation:animationIn_0.8s_ease-out_0.2s_both] leading-[0.95] md:text-6xl lg:text-7xl text-4xl font-medium text-white tracking-tighter mb-8">
        <span>{t.blog_headline_1}</span>
        <br class="hidden md:block">
        <span class="text-neutral-600 transition-colors hover:text-primary duration-500">{t.blog_headline_2}</span>
      </h1>
      
      <!-- Description -->
      <p class="animate-on-scroll [animation:animationIn_0.8s_ease-out_0.3s_both] text-lg md:text-xl text-neutral-400 font-light max-w-2xl mx-auto leading-relaxed">
        {t.blog_desc}
      </p>
    </div>
  </section>

  <!-- ==================== BLOG CONTENT ==================== -->
  <section class="bg-[#050505] border-t border-white/5 py-16">
    <div class="max-w-7xl mx-auto px-4 sm:px-6">
      <!-- Section Header -->
      <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-8 text-[10px] md:text-xs font-mono text-neutral-500 uppercase tracking-[0.2em] gap-4">
        <div class="flex items-center gap-2">
          <span class="text-white">01</span>
          <span class="w-12 h-px bg-white/10"></span>
        </div>
        <div class="text-white/40">// ČLÁNKY</div>
        <div class="hidden md:block text-right">BLOG</div>
      </div>

      <!-- Category Filter - Client-side -->
      <div class="animate-on-scroll [animation:animationIn_0.8s_ease-out_0.4s_both]">
        <div id="blog-filters" class="flex flex-wrap items-center gap-3 mb-12">
          <!-- All Category - Always visible with clear styling -->
          <button 
            data-filter="all"
            class="filter-btn active px-5 py-2.5 rounded-full text-sm font-semibold transition-all duration-300 bg-white text-neutral-900 shadow-md hover:shadow-lg"
          >
            <span class="flex items-center gap-2">
              <iconify-icon icon="solar:list-bold" class="text-base"></iconify-icon>
              {t.blog_category_all}
            </span>
          </button>
          
          <!-- Dynamic Categories -->
          {blogCategories.map((category) => {
            const name = lang === 'cs' ? category.name_cs : category.name_en;
            return (
              <button 
                data-filter={category.id}
                class={`filter-btn px-5 py-2.5 rounded-full text-sm font-semibold flex items-center gap-2 transition-all duration-300 border ${
                  category.id === 'success-story' 
                    ? 'bg-primary/10 text-primary border-primary/30 hover:bg-primary/20' 
                    : 'bg-orange-500/10 text-orange-400 border-orange-500/30 hover:bg-orange-500/20'
                }`}
              >
                <iconify-icon icon={category.icon} class="text-base"></iconify-icon>
                {name}
              </button>
            );
          })}
        </div>
      </div>

      <!-- Blog Posts Container - All cards equal size, left to right -->
      <div id="blog-posts-container">
        <!-- All Posts Grid - Equal sized cards -->
        <div id="posts-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {allPosts.map((post, index) => (
            <div class={`blog-post animate-on-scroll [animation:animationIn_0.8s_ease-out_${0.4 + index * 0.1}s_both]`} data-category={post.category}>
              <BlogCard post={post} lang={lang} />
            </div>
          ))}
        </div>
      </div>

      <!-- No Posts Message (hidden by default) -->
      <div id="no-posts-message" class="text-center py-16 hidden">
        <iconify-icon icon="solar:document-text-linear" class="text-6xl text-neutral-700 mb-4"></iconify-icon>
        <p class="text-neutral-500 text-lg">{t.blog_no_posts}</p>
      </div>
    </div>
  </section>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const filterButtons = document.querySelectorAll('.filter-btn');
      const blogPosts = document.querySelectorAll('.blog-post');
      const noPostsMessage = document.getElementById('no-posts-message');
      const postsContainer = document.getElementById('blog-posts-container');

      // Check URL params on load
      const urlParams = new URLSearchParams(window.location.search);
      const initialCategory = urlParams.get('category') || 'all';
      
      // Apply initial filter
      applyFilter(initialCategory);

      filterButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const filter = btn.getAttribute('data-filter');
          applyFilter(filter);
          
          // Update URL without reload
          const url = new URL(window.location.href);
          if (filter === 'all') {
            url.searchParams.delete('category');
          } else {
            url.searchParams.set('category', filter);
          }
          window.history.pushState({}, '', url);
        });
      });

      function applyFilter(filter: string | null) {
        let visibleCount = 0;

        // Update button styles
        filterButtons.forEach(btn => {
          const btnFilter = btn.getAttribute('data-filter');
          const isActive = btnFilter === filter;
          
          btn.classList.remove('active', 'bg-white', 'text-neutral-900', 'bg-primary', 'bg-orange-500', 'shadow-md', 'shadow-lg', 'bg-white/10', 'text-white');
          
          if (isActive) {
            btn.classList.add('active');
            if (btnFilter === 'all') {
              btn.classList.add('bg-white', 'text-neutral-900', 'shadow-lg');
            } else if (btnFilter === 'success-story') {
              btn.classList.add('bg-primary', 'text-white', 'shadow-lg');
              btn.classList.remove('bg-primary/10', 'text-primary');
            } else if (btnFilter === 'tutorial') {
              btn.classList.add('bg-orange-500', 'text-white', 'shadow-lg');
              btn.classList.remove('bg-orange-500/10', 'text-orange-400');
            }
          } else {
            if (btnFilter === 'all') {
              btn.classList.add('bg-white/10', 'text-white');
              btn.classList.remove('bg-white', 'text-neutral-900', 'shadow-lg');
            } else if (btnFilter === 'success-story') {
              btn.classList.add('bg-primary/10', 'text-primary');
              btn.classList.remove('bg-primary', 'text-white', 'shadow-lg');
            } else if (btnFilter === 'tutorial') {
              btn.classList.add('bg-orange-500/10', 'text-orange-400');
              btn.classList.remove('bg-orange-500', 'text-white', 'shadow-lg');
            }
          }
        });

        // Filter posts
        blogPosts.forEach(post => {
          const postCategory = post.getAttribute('data-category');
          const shouldShow = filter === 'all' || postCategory === filter;
          
          if (shouldShow) {
            post.classList.remove('hidden');
            visibleCount++;
          } else {
            post.classList.add('hidden');
          }
        });

        // Show/hide no posts message
        if (visibleCount === 0) {
          noPostsMessage?.classList.remove('hidden');
          postsContainer?.classList.add('hidden');
        } else {
          noPostsMessage?.classList.add('hidden');
          postsContainer?.classList.remove('hidden');
        }
      }
    });
  </script>

</PageLayout>

