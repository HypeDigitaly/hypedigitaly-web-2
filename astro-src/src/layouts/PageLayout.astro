---
import BaseLayout from './BaseLayout.astro';
import Navigation from '../components/navigation/Navigation.astro';
import MobileMenu from '../components/navigation/MobileMenu.astro';
import Footer from '../components/sections/Footer.astro';
import DigitalRain from '../components/ui/DigitalRain.astro';
import GridBackground from '../components/ui/GridBackground.astro';
import CookieConsent from '../components/ui/CookieConsent.astro';

export interface Props {
  title: string;
  description?: string;
  ogImage?: string;
  ogUrl?: string;
  lang?: 'cs' | 'en';
  showDigitalRain?: boolean;
  showGrid?: boolean;
  simpleNav?: boolean;
  simpleFooter?: boolean;
  showCalendar?: boolean;
}

const { 
  title, 
  description,
  ogImage,
  ogUrl,
  lang = 'cs',
  showDigitalRain = true,
  showGrid = true,
  simpleNav = false,
  simpleFooter = false,
  showCalendar = true,
} = Astro.props;
---

<BaseLayout title={title} description={description} ogImage={ogImage} ogUrl={ogUrl} lang={lang}>
  {showDigitalRain && <DigitalRain />}
  {showGrid && <GridBackground />}
  
  <Navigation lang={lang} simple={simpleNav} />
  <MobileMenu lang={lang} />
  
  <main id="main-content" class="z-10 relative pt-32 overflow-x-hidden" role="main">
    <slot />
  </main>
  
  <Footer lang={lang} simple={simpleFooter} showCalendar={showCalendar} />
  
  <!-- GDPR Cookie Consent Banner -->
  <CookieConsent lang={lang} />
  
  <Fragment slot="scripts">
    <script>
      // ==================== OPTIMIZED PAGE INITIALIZATION ====================
      (function() {
        'use strict';
        
        // Helper to set cookie
        function setLangCookie(lang) {
          const maxAge = 60 * 60 * 24 * 365; // 1 year
          document.cookie = `preferredLanguage=${lang};path=/;max-age=${maxAge};SameSite=Lax`;
        }

        // Helper to get cookie value
        function getLangCookie() {
          const match = document.cookie.match(/preferredLanguage=(cs|en)/);
          return match ? match[1] : null;
        }

      // Initialize language on page load
      document.addEventListener('DOMContentLoaded', () => {
        // Language dropdown
        const langTrigger = document.getElementById('lang-trigger');
        const langDropdown = document.getElementById('lang-dropdown');

        langTrigger?.addEventListener('click', (e) => {
          e.stopPropagation();
          const isHidden = langDropdown?.classList.toggle('hidden');
          langTrigger.setAttribute('aria-expanded', (!isHidden).toString());
        });

        document.addEventListener('click', (e) => {
          if (!e.target.closest('#lang-switcher')) {
            langDropdown?.classList.add('hidden');
            langTrigger?.setAttribute('aria-expanded', 'false');
          }
        });

        // Language buttons - close dropdown and reload with new language
        document.querySelectorAll('[data-lang]').forEach(btn => {
          btn.addEventListener('click', () => {
            const lang = btn.getAttribute('data-lang');
            if (!lang || (lang !== 'cs' && lang !== 'en')) return;
            
            // Close dropdown immediately
            langDropdown?.classList.add('hidden');
            
            // Set cookie for persistence across navigations
            setLangCookie(lang);
            
            // Build URL based on language
            const url = new URL(window.location.href);
            
            if (lang === 'cs') {
              // Czech is default - redirect to clean URL (remove ?lang param)
              url.searchParams.delete('lang');
            } else {
              // English - add ?lang=en
              url.searchParams.set('lang', lang);
            }
            
            // Navigate to the appropriate URL
            window.location.href = url.toString();
          });
        });
      });

      // ==================== MOBILE MENU ====================
      const mobileMenuBtn = document.getElementById('mobile-menu-btn');
      const mobileMenuClose = document.getElementById('mobile-menu-close');
      const mobileMenu = document.getElementById('mobile-menu');

      function getFocusableElements(container) {
        return container.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
      }

      function handleTrapFocus(e, container) {
        const focusableElements = getFocusableElements(container);
        const firstFocusableElement = focusableElements[0];
        const lastFocusableElement = focusableElements[focusableElements.length - 1];

        const isTabPressed = e.key === 'Tab' || e.keyCode === 9;

        if (!isTabPressed) return;

        if (e.shiftKey) {
          if (document.activeElement === firstFocusableElement) {
            lastFocusableElement.focus();
            e.preventDefault();
          }
        } else {
          if (document.activeElement === lastFocusableElement) {
            firstFocusableElement.focus();
            e.preventDefault();
          }
        }
      }

      function openMobileMenu() {
        mobileMenu?.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        mobileMenuBtn?.setAttribute('aria-expanded', 'true');
        
        // Focus first element in menu
        setTimeout(() => {
          const focusableElements = getFocusableElements(mobileMenu);
          if (focusableElements.length > 0) focusableElements[0].focus();
        }, 100);

        mobileMenu?.addEventListener('keydown', (e) => handleTrapFocus(e, mobileMenu));
      }

      function closeMobileMenu() {
        mobileMenu?.classList.add('hidden');
        document.body.style.overflow = '';
        mobileMenuBtn?.setAttribute('aria-expanded', 'false');
        mobileMenuBtn?.focus();
        
        mobileMenu?.removeEventListener('keydown', (e) => handleTrapFocus(e, mobileMenu));
      }

      mobileMenuBtn?.addEventListener('click', () => {
        if (mobileMenu?.classList.contains('hidden')) {
          openMobileMenu();
        } else {
          closeMobileMenu();
        }
      });

      mobileMenuClose?.addEventListener('click', closeMobileMenu);

      mobileMenu?.querySelectorAll('a').forEach(link => {
        link.addEventListener('click', closeMobileMenu);
      });

      mobileMenu?.addEventListener('click', (e) => {
        if (e.target === mobileMenu) {
          closeMobileMenu();
        }
      });

      // Escape key to close
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          if (!mobileMenu?.classList.contains('hidden')) closeMobileMenu();
          if (servicesOpen) closeServicesDropdown();
          langDropdown?.classList.add('hidden');
          langTrigger?.setAttribute('aria-expanded', 'false');
        }
      });

      // ==================== DESKTOP SERVICES DROPDOWN ====================
      const servicesTrigger = document.getElementById('services-trigger');
      const servicesMenu = document.getElementById('services-menu');
      const servicesArrow = document.getElementById('services-arrow');
      const servicesDropdown = document.getElementById('services-dropdown');
      let servicesOpen = false;

      function openServicesDropdown() {
        servicesOpen = true;
        servicesMenu?.classList.remove('opacity-0', 'invisible', 'pointer-events-none');
        servicesMenu?.classList.add('opacity-100', 'visible', 'pointer-events-auto');
        servicesArrow?.classList.add('rotate-180');
        servicesTrigger?.classList.add('text-white');
        servicesTrigger?.setAttribute('aria-expanded', 'true');
      }

      function closeServicesDropdown() {
        servicesOpen = false;
        servicesMenu?.classList.add('opacity-0', 'invisible', 'pointer-events-none');
        servicesMenu?.classList.remove('opacity-100', 'visible', 'pointer-events-auto');
        servicesArrow?.classList.remove('rotate-180');
        servicesTrigger?.classList.remove('text-white');
        servicesTrigger?.setAttribute('aria-expanded', 'false');
      }

      servicesTrigger?.addEventListener('click', (e) => {
        e.stopPropagation();
        if (servicesOpen) {
          closeServicesDropdown();
        } else {
          openServicesDropdown();
        }
      });

      servicesDropdown?.addEventListener('mouseenter', openServicesDropdown);
      servicesDropdown?.addEventListener('mouseleave', closeServicesDropdown);

      document.addEventListener('click', (e) => {
        if (!e.target.closest('#services-dropdown')) {
          closeServicesDropdown();
        }
      });

      // Keyboard support for services menu
      servicesMenu?.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeServicesDropdown();
      });

      // ==================== MOBILE SERVICES SUBMENU ====================
      const mobileServicesToggle = document.getElementById('mobile-services-toggle');
      const mobileServicesSubmenu = document.getElementById('mobile-services-submenu');
      const mobileServicesArrow = document.getElementById('mobile-services-arrow');

      mobileServicesToggle?.addEventListener('click', () => {
        mobileServicesSubmenu?.classList.toggle('hidden');
        mobileServicesArrow?.classList.toggle('rotate-180');
      });

      // ==================== NAVBAR SCROLL EFFECT ====================
      let lastScroll = 0;
      const navbar = document.querySelector('nav');
      
      window.addEventListener('scroll', () => {
        const currentScroll = window.pageYOffset;
        
        if (currentScroll > 100) {
          navbar?.classList.add('bg-neutral-950/95', 'shadow-lg');
        } else {
          navbar?.classList.remove('bg-neutral-950/95', 'shadow-lg');
        }
        
        lastScroll = currentScroll;
      });

      // ==================== FAQ ACCORDION ====================
      document.querySelectorAll('.faq-trigger').forEach(trigger => {
        trigger.addEventListener('click', () => {
          const faqItem = trigger.closest('.faq-item');
          const isActive = faqItem?.classList.contains('active');
          
          // Close all other items
          document.querySelectorAll('.faq-item').forEach(item => {
            item.classList.remove('active');
          });
          
          // Toggle current item
          if (!isActive) {
            faqItem?.classList.add('active');
          }
        });
      });
      })(); // End IIFE
    </script>
  </Fragment>
</BaseLayout>

