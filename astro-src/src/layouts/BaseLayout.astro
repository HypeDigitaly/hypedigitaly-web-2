---
import '../styles/global.css';

export interface Props {
  title: string;
  description?: string;
  ogImage?: string;
  ogUrl?: string;
  lang?: 'cs' | 'en';
  canonicalPath?: string;
  noindex?: boolean;
  articleMeta?: {
    publishedTime?: string;
    modifiedTime?: string;
    author?: string;
    section?: string;
    tags?: string[];
  };
}

const SITE_URL = 'https://hypedigitaly.ai';

const { 
  title, 
  description = 'HypeDigitaly je AI Transformation Partner. Pomáháme organizacím implementovat AI chatboty, voiceboty, AI agenty a automatizace.',
  ogImage = '/assets/images/og-image.jpg',
  ogUrl,
  lang = 'cs',
  canonicalPath,
  noindex = false,
  articleMeta
} = Astro.props;

// Derive canonical URL from current path or explicit prop
const currentPath = Astro.url.pathname;
const cleanPath = canonicalPath || currentPath.replace(/\/$/, '') || '/';

// Build canonical URL (Czech = clean URL, English = with ?lang=en)
const canonicalUrl = lang === 'en' 
  ? `${SITE_URL}${cleanPath}?lang=en`
  : `${SITE_URL}${cleanPath}`;

// Build hreflang URLs
const csUrl = `${SITE_URL}${cleanPath}`;
const enUrl = `${SITE_URL}${cleanPath}${cleanPath === '/' ? '?lang=en' : '?lang=en'}`;

// Build OG URL (use provided or canonical)
const finalOgUrl = ogUrl || canonicalUrl;

// Build full OG image URL
const fullOgImage = ogImage.startsWith('http') ? ogImage : `${SITE_URL}${ogImage}`;

// Organization JSON-LD (only on homepage or if not article)
const isHomepage = cleanPath === '/' || cleanPath === '';

// Organization structured data
const organizationSchema = {
  "@context": "https://schema.org",
  "@type": "Organization",
  "@id": `${SITE_URL}/#organization`,
  "name": "HypeDigitaly s.r.o.",
  "alternateName": "HypeDigitaly",
  "url": SITE_URL,
  "logo": {
    "@type": "ImageObject",
    "url": `${SITE_URL}/assets/images/logo.png`,
    "width": 512,
    "height": 512
  },
  "image": `${SITE_URL}/assets/images/og-image.jpg`,
  "description": lang === 'cs' 
    ? "HypeDigitaly je AI Transformation Partner. Pomáháme organizacím implementovat AI chatboty, voiceboty, AI agenty a automatizace."
    : "HypeDigitaly is an AI Transformation Partner. We help organizations implement AI chatbots, voicebots, AI agents and automation.",
  "address": {
    "@type": "PostalAddress",
    "streetAddress": "Velká Hradební 2800/54",
    "addressLocality": "Ústí nad Labem",
    "postalCode": "400 01",
    "addressCountry": "CZ"
  },
  "geo": {
    "@type": "GeoCoordinates",
    "latitude": 50.661664,
    "longitude": 14.040413
  },
  "contactPoint": [
    {
      "@type": "ContactPoint",
      "telephone": "+420-774-996-248",
      "email": "info@hypedigitaly.ai",
      "contactType": "customer service",
      "availableLanguage": ["Czech", "English"]
    }
  ],
  "sameAs": [
    "https://linkedin.com/company/hypedigitaly",
    "https://www.instagram.com/hypedigitaly_ai/",
    "https://www.facebook.com/HypeDigitalyAI/",
    "https://www.youtube.com/@PavelCermakAI"
  ],
  "founder": {
    "@type": "Person",
    "name": "Pavel Čermák",
    "jobTitle": "CEO & CTO",
    "url": "https://www.linkedin.com/in/cermakai/"
  },
  "foundingDate": "2022",
  "numberOfEmployees": {
    "@type": "QuantitativeValue",
    "minValue": 2,
    "maxValue": 10
  },
  "slogan": lang === 'cs' ? "První AI agentura v ČR" : "First AI Agency in Czech Republic",
  "knowsAbout": [
    "Artificial Intelligence",
    "AI Chatbots",
    "Voicebots",
    "RAG Systems",
    "AI Automation",
    "Machine Learning"
  ],
  "areaServed": {
    "@type": "Country",
    "name": "Czech Republic"
  }
};

// WebSite structured data (for sitelinks search box)
const websiteSchema = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  "@id": `${SITE_URL}/#website`,
  "url": SITE_URL,
  "name": "HypeDigitaly",
  "description": description,
  "publisher": {
    "@id": `${SITE_URL}/#organization`
  },
  "inLanguage": lang === 'cs' ? "cs-CZ" : "en-US"
};
---

<!DOCTYPE html>
<html lang={lang} class="antialiased dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{title}</title>
  <meta name="description" content={description}>
  
  <!-- Robots -->
  <meta name="robots" content={noindex ? "noindex, nofollow" : "index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1"}>
  <meta name="googlebot" content={noindex ? "noindex, nofollow" : "index, follow"}>
  
  <!-- Author & Publisher -->
  <meta name="author" content="HypeDigitaly s.r.o.">
  <meta name="publisher" content="HypeDigitaly">
  <link rel="author" href="https://www.linkedin.com/in/cermakai/">
  
  <!-- Canonical URL -->
  <link rel="canonical" href={canonicalUrl}>
  
  <!-- Hreflang for Multilingual SEO -->
  <link rel="alternate" hreflang="cs" href={csUrl}>
  <link rel="alternate" hreflang="en" href={enUrl}>
  <link rel="alternate" hreflang="x-default" href={csUrl}>
  
  <!-- Open Graph -->
  <meta property="og:type" content={articleMeta ? "article" : "website"}>
  <meta property="og:site_name" content="HypeDigitaly">
  <meta property="og:title" content={title}>
  <meta property="og:description" content={description}>
  <meta property="og:image" content={fullOgImage}>
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:url" content={finalOgUrl}>
  <meta property="og:locale" content={lang === 'cs' ? "cs_CZ" : "en_US"}>
  <meta property="og:locale:alternate" content={lang === 'cs' ? "en_US" : "cs_CZ"}>
  
  {articleMeta && (
    <>
      {articleMeta.publishedTime && <meta property="article:published_time" content={articleMeta.publishedTime} />}
      {articleMeta.modifiedTime && <meta property="article:modified_time" content={articleMeta.modifiedTime} />}
      {articleMeta.author && <meta property="article:author" content={articleMeta.author} />}
      {articleMeta.section && <meta property="article:section" content={articleMeta.section} />}
      {articleMeta.tags && articleMeta.tags.map(tag => <meta property="article:tag" content={tag} />)}
    </>
  )}
  
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content={title}>
  <meta name="twitter:description" content={description}>
  <meta name="twitter:image" content={fullOgImage}>
  <meta name="twitter:image:alt" content={title}>
  
  <!-- Favicon -->
  <link rel="icon" href="/assets/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicon.ico">
  <link rel="apple-touch-icon" href="/assets/images/logo.png">
  
  <!-- Preload Critical Hero Assets -->
  <link rel="preload" href="/assets/images/HD_Color_logo.png" as="image" fetchpriority="high">
  <link rel="preload" href="/assets/images/logo.png" as="image" media="(min-width: 1024px)" fetchpriority="high">
  
  <!-- Preconnect for Performance - Critical Resources -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://code.iconify.design">
  <link rel="preconnect" href="https://i.ytimg.com">
  
  <!-- DNS Prefetch for Third-Party Resources (lazy-loaded) -->
  <link rel="dns-prefetch" href="https://www.youtube.com">
  <link rel="dns-prefetch" href="https://www.google.com">
  <link rel="dns-prefetch" href="https://app.cal.com">
  <link rel="dns-prefetch" href="https://i.ytimg.com">
  
  <!-- Fonts with optimized loading (Async) -->
  <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Geist:wght@300;400;500;600;700&display=swap" onload="this.onload=null;this.rel='stylesheet'">
  <noscript>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  </noscript>
  
  <!-- Preload critical CSS -->
  <link rel="preload" href="/src/styles/global.css" as="style">
  
  <!-- Iconify - Defer loading to prevent blocking -->
  <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js" defer></script>
  
  <!-- Structured Data: Organization -->
  <script type="application/ld+json" set:html={JSON.stringify(organizationSchema)} />
  
  <!-- Structured Data: WebSite -->
  <script type="application/ld+json" set:html={JSON.stringify(websiteSchema)} />
  
  <!-- Google Consent Mode v2 (Default Denied) -->
  <script is:inline>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('consent', 'default', {
      'analytics_storage': 'denied',
      'ad_storage': 'denied',
      'ad_user_data': 'denied',
      'ad_personalization': 'denied',
      'functionality_storage': 'denied',
      'personalization_storage': 'denied',
      'wait_for_update': 500
    });
  </script>

  <!-- Google Analytics 4 (GA4) - Conditional on Cookie Consent -->
  <script is:inline type="text/plain" data-cookiecategory="analytics" src="https://www.googletagmanager.com/gtag/js?id=G-Q87Y31XNEB" async></script>
  <script is:inline type="text/plain" data-cookiecategory="analytics">
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-Q87Y31XNEB', {
      'anonymize_ip': true,
      'cookie_flags': 'SameSite=None;Secure'
    });
  </script>

  <!-- Microsoft Clarity - Conditional on Cookie Consent -->
  <script is:inline type="text/plain" data-cookiecategory="analytics">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "ut81mc242l");
  </script>

  <slot name="head" />
</head>
<body class="relative min-h-screen overflow-x-hidden selection:bg-primary/20 selection:text-white font-geist">
  <a href="#main-content" class="skip-link">
    {lang === 'cs' ? 'Přeskočit na hlavní obsah' : 'Skip to main content'}
  </a>
  <slot />
  
  <!-- Core JavaScript - Optimized -->
  <script>
    // ==================== SCROLL ANIMATIONS ====================
    (function () {
      const once = true;
      if (!window.__inViewIO) {
        window.__inViewIO = new IntersectionObserver((entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              entry.target.classList.add("animate");
              if (once) window.__inViewIO.unobserve(entry.target);
            }
          });
        }, { threshold: 0.1, rootMargin: "0px 0px -5% 0px" });
      }
      window.initInViewAnimations = function (selector = ".animate-on-scroll") {
        document.querySelectorAll(selector).forEach((el) => {
          window.__inViewIO.observe(el);
        });
      };
      document.addEventListener("DOMContentLoaded", () => {
        window.initInViewAnimations();
      });
    })();

    // ==================== SMOOTH SCROLL (Robust Implementation) ====================
    (function() {
      const NAVBAR_HEIGHT = 96; // 6rem = 96px

      // Helper to calculate target scroll position
      const getTargetPosition = (element) => {
        const elementTop = element.getBoundingClientRect().top + window.scrollY;
        return elementTop - NAVBAR_HEIGHT;
      };

      // Robust scroll function with verification
      const performScroll = (targetId, isInitialLoad = false) => {
        const target = document.querySelector(targetId);
        if (!target) return;

        const targetPos = getTargetPosition(target);
        
        // Initial scroll
        window.scrollTo({
          top: targetPos,
          behavior: isInitialLoad ? 'auto' : 'smooth'
        });

        // Verification & Retry for layout shifts
        setTimeout(() => {
          const currentPos = getTargetPosition(target);
          if (Math.abs(window.scrollY - currentPos) > 10) {
            window.scrollTo({
              top: currentPos,
              behavior: 'smooth'
            });
          }
        }, isInitialLoad ? 100 : 500);
      };

      // Handle hash in URL on page load
      const handleHashOnLoad = () => {
        if (window.location.hash) {
          // Wait for DOM and images to be somewhat stable
          if (document.readyState === 'complete') {
            performScroll(window.location.hash, true);
          } else {
            window.addEventListener('load', () => performScroll(window.location.hash, true), { once: true });
          }
        }
      };

      // Page-specific hash mappings
      const pageHashMap = {
        '/priprava-dat': {
          'priprava-dat': 'ragus'
        }
      };

      // Normalize paths for comparison
      const normalizePath = (path) => {
        if (!path || path === '/') return '/';
        return path.replace(/\/$/, '').replace(/^\/(en|cs)(\/|$)/, '/');
      };

      // Handle clicks
      document.addEventListener('click', function(e) {
        const anchor = e.target.closest('a[href*="#"]');
        if (!anchor) return;

        try {
          const url = new URL(anchor.href);
          if (url.origin !== window.location.origin) return;

          const normalizedUrlPath = normalizePath(url.pathname);
          const normalizedCurrentPath = normalizePath(window.location.pathname);
          
          let targetHash = url.hash;
          let shouldIntercept = normalizedUrlPath === normalizedCurrentPath;

          // Universal local-first check
          if (!shouldIntercept && targetHash) {
            const hashWithoutPound = targetHash.substring(1);
            if (document.getElementById(hashWithoutPound)) {
              shouldIntercept = true;
            } else {
              // Check mappings
              const mappings = pageHashMap[normalizedCurrentPath];
              if (mappings && mappings[hashWithoutPound]) {
                const localId = mappings[hashWithoutPound];
                if (document.getElementById(localId)) {
                  targetHash = '#' + localId;
                  shouldIntercept = true;
                }
              }
            }
          }

          if (shouldIntercept && targetHash) {
            const target = document.querySelector(targetHash);
            if (target) {
              e.preventDefault();
              
              // Close mobile menu
              const mobileMenu = document.getElementById('mobile-menu');
              if (mobileMenu && !mobileMenu.classList.contains('hidden')) {
                const closeBtn = document.getElementById('mobile-menu-close');
                if (closeBtn) closeBtn.click();
                else {
                  mobileMenu.classList.add('hidden');
                  document.body.style.overflow = '';
                }
              }

              performScroll(targetHash);
              history.pushState(null, '', targetHash);
            }
          }
        } catch (err) {
          // Fallback
        }
      }, { passive: false });

      // Initialize on load and on Astro page transitions
      handleHashOnLoad();
      document.addEventListener('astro:page-load', handleHashOnLoad);
    })();
  </script>
  
  <slot name="scripts" />
</body>
</html>
